---
---

<div id="page-loading" class="fixed inset-0 z-[9999] flex items-center justify-center bg-[var(--page-bg)]" style="display: none;">
	<div class="loading-spinner"></div>
</div>

<style>
	#page-loading {
		--spinner-size: 40px;
		--spinner-border-width: 3px;
		/* 浅色模式直接使用主题色 */
		--spinner-color: var(--primary);
		--spinner-bg-color: oklch(0.92 0.01 0);
	}

	.loading-spinner {
		width: var(--spinner-size);
		height: var(--spinner-size);
		border: var(--spinner-border-width) solid var(--spinner-bg-color);
		border-top-color: var(--spinner-color);
		border-radius: 50%;
		animation: spin 0.8s linear infinite;
	}

	@keyframes spin {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}

	/* 暗色模式适配 */
	:root.dark #page-loading {
		--spinner-bg-color: oklch(0.20 0.014 0);
		/* 深色模式下使用更亮的旋转色以确保可见性 */
		--spinner-color: oklch(0.85 0.14 var(--hue));
	}
</style>

<script>
	// 加载时间阈值（毫秒），超过这个时间才显示Loading
	// 设置为800ms，避免在快速刷新时显示加载动画
	const LOADING_THRESHOLD = 800;
	
	// 记录页面开始加载的时间（使用navigationStart或timeOrigin）
	function getLoadStartTime() {
		if (performance.timing && performance.timing.navigationStart) {
			return performance.timing.navigationStart;
		}
		if (performance.timeOrigin) {
			return performance.timeOrigin;
		}
		// 降级方案：使用当前时间减去已过去的时间
		return Date.now() - performance.now();
	}
	
	const loadStartTime = getLoadStartTime();
	let loadingShown = false;
	let pageReady = false;
	
	// 获取已加载时间（毫秒）
	function getElapsedTime() {
		return Date.now() - loadStartTime;
	}

	function showLoading() {
		const loadingElement = document.getElementById('page-loading');
		if (loadingElement && !loadingShown) {
			loadingElement.style.display = 'flex';
			loadingShown = true;
		}
	}

	function hideLoading() {
		const loadingElement = document.getElementById('page-loading');
		if (loadingElement && loadingElement.parentNode) {
			loadingElement.parentNode.removeChild(loadingElement);
		}
	}

	function checkAndShowLoading() {
		const elapsed = getElapsedTime();
		if (elapsed >= LOADING_THRESHOLD && !pageReady) {
			showLoading();
		}
	}

	function checkPageReady() {
		// 检查页面是否已经标记为ready（通过banner-ready类）
		function checkBannerReady() {
			if (document.body && document.body.classList.contains('banner-ready')) {
				return true;
			}
			return false;
		}

		// 如果banner已经ready，标记为完成
		if (checkBannerReady()) {
			handlePageReady();
			return;
		}

		// 监听banner-ready类的添加
		let observer: MutationObserver | null = null;
		if (document.body) {
			observer = new MutationObserver(() => {
				if (checkBannerReady() && !pageReady) {
					pageReady = true;
					if (observer) {
						observer.disconnect();
					}
					handlePageReady();
				}
			});
			observer.observe(document.body, {
				attributes: true,
				attributeFilter: ['class']
			});
			
			// 清理observer的函数
			const cleanup = () => {
				if (observer) {
					observer.disconnect();
					observer = null;
				}
			};
			
			// 确保在页面卸载时清理
			window.addEventListener('beforeunload', cleanup);
		}

		// 定期检查加载时间，如果超过阈值就显示Loading
		const checkInterval = setInterval(() => {
			if (!pageReady) {
				checkAndShowLoading();
			} else {
				clearInterval(checkInterval);
			}
		}, 50); // 每50ms检查一次

		// 等待window.onload确保所有资源加载完成
		if (document.readyState === 'complete') {
			// 如果DOM已经完成，但banner还没ready，等待最多2秒
			setTimeout(() => {
				if (!pageReady) {
					pageReady = true;
					if (observer) {
						observer.disconnect();
					}
					if (checkInterval) {
						clearInterval(checkInterval);
					}
					handlePageReady();
				}
			}, 2000);
		} else {
			window.addEventListener('load', () => {
				// window.onload后，等待最多1秒让banner加载
				setTimeout(() => {
					if (!pageReady) {
						pageReady = true;
						if (observer) {
							observer.disconnect();
						}
						if (checkInterval) {
							clearInterval(checkInterval);
						}
						handlePageReady();
					}
				}, 1000);
			}, { once: true });
		}

		// 如果3秒后还没加载完成，也隐藏loading（避免一直显示）
		setTimeout(() => {
			if (!pageReady) {
				pageReady = true;
				if (observer) {
					observer.disconnect();
				}
				if (checkInterval) {
					clearInterval(checkInterval);
				}
				handlePageReady();
			}
		}, 3000);
	}

	function handlePageReady() {
		pageReady = true;
		
		// 如果已经显示了Loading，等待一小段时间确保页面渲染完成
		if (loadingShown) {
			setTimeout(() => {
				hideLoading();
			}, 100);
		} else {
			// 页面快速加载完成，直接隐藏，不显示Loading
			hideLoading();
		}
	}

	function initLoading() {
		// 等待DOM加载
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', () => {
				checkPageReady();
			});
		} else {
			checkPageReady();
		}

		// 立即开始检查加载时间
		setTimeout(() => {
			checkAndShowLoading();
		}, LOADING_THRESHOLD);
	}

	// 初始化
	initLoading();
</script>
